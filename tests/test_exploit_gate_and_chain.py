from __future__ import annotations

import json
from pathlib import Path
from typing import cast

from aiedge.run import analyze_run, create_run, run_subset


def _write_firmware(tmp_path: Path) -> Path:
    fw = tmp_path / "fw.bin"
    _ = fw.write_bytes(b"FW")
    return fw


def _set_profile_exploit(manifest_path: Path) -> None:
    obj = cast(dict[str, object], json.loads(manifest_path.read_text(encoding="utf-8")))
    obj["profile"] = "exploit"
    obj["exploit_gate"] = {
        "flag": "flag",
        "attestation": "authorized",
        "scope": "lab-only",
    }
    _ = manifest_path.write_text(
        json.dumps(obj, indent=2, sort_keys=True, ensure_ascii=True) + "\n",
        encoding="utf-8",
    )


def test_exploit_stages_are_skipped_in_analysis_profile(tmp_path: Path) -> None:
    fw = _write_firmware(tmp_path)
    info = create_run(
        str(fw),
        case_id="case-exploit-skip",
        ack_authorization=True,
        runs_root=tmp_path / "runs",
    )
    rep = run_subset(
        info, ["exploit_gate", "exploit_chain"], time_budget_s=5, no_llm=True
    )
    assert rep.status in ("ok", "partial", "skipped")

    stage_json = info.run_dir / "stages" / "exploit_gate" / "stage.json"
    raw_obj = cast(object, json.loads(stage_json.read_text(encoding="utf-8")))
    assert cast(dict[str, object], raw_obj).get("status") == "skipped"


def test_exploit_stages_run_when_profile_and_gate_present(tmp_path: Path) -> None:
    fw = _write_firmware(tmp_path)
    info = create_run(
        str(fw),
        case_id="case-exploit-ok",
        ack_authorization=True,
        runs_root=tmp_path / "runs",
    )
    _set_profile_exploit(info.manifest_path)

    rep = run_subset(
        info, ["exploit_gate", "exploit_chain"], time_budget_s=5, no_llm=True
    )
    assert rep.status in ("ok", "partial")

    gate_obj = cast(
        object,
        json.loads(
            (info.run_dir / "stages" / "exploit_gate" / "stage.json").read_text(
                encoding="utf-8"
            )
        ),
    )
    assert cast(dict[str, object], gate_obj).get("status") == "ok"

    milestones = info.run_dir / "stages" / "exploit_chain" / "milestones.json"
    assert milestones.is_file()
    obj = cast(dict[str, object], json.loads(milestones.read_text(encoding="utf-8")))
    assert cast(dict[str, object], obj.get("canonical_input")).get("path") == (
        "input/firmware.bin"
    )
    assert cast(dict[str, object], obj.get("canonical_input")).get("sha256") == cast(
        dict[str, object],
        json.loads(info.manifest_path.read_text(encoding="utf-8")),
    ).get("input_sha256")
    ids = [
        cast(dict[str, object], m).get("id")
        for m in cast(list[object], obj.get("milestones"))
    ]
    assert ids == ["reachability", "bounded_impact", "postcondition"]


def test_analyze_run_exposes_exploit_stage_statuses_in_report(tmp_path: Path) -> None:
    fw = _write_firmware(tmp_path)
    info = create_run(
        str(fw),
        case_id="case-exploit-report-status",
        ack_authorization=True,
        runs_root=tmp_path / "runs",
    )
    _set_profile_exploit(info.manifest_path)

    _ = analyze_run(info, time_budget_s=2, no_llm=True)
    report = cast(
        dict[str, object],
        json.loads(info.report_json_path.read_text(encoding="utf-8")),
    )
    digest = cast(
        dict[str, object],
        json.loads(
            (info.run_dir / "report" / "analyst_digest.json").read_text(
                encoding="utf-8"
            )
        ),
    )

    for stage_name in (
        "exploit_gate",
        "exploit_chain",
        "poc_validation",
        "exploit_policy",
    ):
        stage_report_any = report.get(stage_name)
        assert isinstance(stage_report_any, dict)
        stage_report = cast(dict[str, object], stage_report_any)

        stage_manifest = cast(
            dict[str, object],
            json.loads(
                (
                    info.run_dir / "stages" / stage_name / "stage.json"
                ).read_text(encoding="utf-8")
            ),
        )
        expected_status = stage_manifest.get("status")
        assert stage_report.get("status") == expected_status
        assert stage_report.get("status") != "pending"

    assessment_any = report.get("exploit_assessment")
    assert isinstance(assessment_any, dict)
    assessment = cast(dict[str, object], assessment_any)
    verdict_any = digest.get("exploitability_verdict")
    assert isinstance(verdict_any, dict)
    verdict = cast(dict[str, object], verdict_any)
    assert assessment.get("profile") == "exploit"
    assert assessment.get("decision") == verdict.get("state")
    assert assessment.get("reason_codes") == verdict.get("reason_codes")
    assert assessment.get("decision") == "NOT_ATTEMPTED"
    assert assessment.get("reason_codes") == [
        "NOT_ATTEMPTED_REQUIRED_VERIFIER_MISSING"
    ]
    assert assessment.get("exploitable") is None

    stage_statuses_any = assessment.get("stage_statuses")
    assert isinstance(stage_statuses_any, dict)
    stage_statuses = cast(dict[str, object], stage_statuses_any)
    for stage_name in (
        "exploit_gate",
        "exploit_chain",
        "poc_validation",
        "exploit_policy",
    ):
        stage_report = cast(dict[str, object], report.get(stage_name))
        assert stage_statuses.get(stage_name) == stage_report.get("status")
