from __future__ import annotations

import json
from pathlib import Path
from typing import cast

from aiedge.run import create_run, run_subset


def _write_firmware(tmp_path: Path) -> Path:
    fw = tmp_path / "fw.bin"
    _ = fw.write_bytes(b"FW")
    return fw


def _set_profile_exploit(manifest_path: Path) -> None:
    obj = cast(dict[str, object], json.loads(manifest_path.read_text(encoding="utf-8")))
    obj["profile"] = "exploit"
    obj["exploit_gate"] = {
        "flag": "flag",
        "attestation": "authorized",
        "scope": "lab-only",
    }
    _ = manifest_path.write_text(
        json.dumps(obj, indent=2, sort_keys=True, ensure_ascii=True) + "\n",
        encoding="utf-8",
    )


def test_exploit_stages_are_skipped_in_analysis_profile(tmp_path: Path) -> None:
    fw = _write_firmware(tmp_path)
    info = create_run(
        str(fw),
        case_id="case-exploit-skip",
        ack_authorization=True,
        runs_root=tmp_path / "runs",
    )
    rep = run_subset(
        info, ["exploit_gate", "exploit_chain"], time_budget_s=5, no_llm=True
    )
    assert rep.status in ("ok", "partial", "skipped")

    stage_json = info.run_dir / "stages" / "exploit_gate" / "stage.json"
    raw_obj = cast(object, json.loads(stage_json.read_text(encoding="utf-8")))
    assert cast(dict[str, object], raw_obj).get("status") == "skipped"


def test_exploit_stages_run_when_profile_and_gate_present(tmp_path: Path) -> None:
    fw = _write_firmware(tmp_path)
    info = create_run(
        str(fw),
        case_id="case-exploit-ok",
        ack_authorization=True,
        runs_root=tmp_path / "runs",
    )
    _set_profile_exploit(info.manifest_path)

    rep = run_subset(
        info, ["exploit_gate", "exploit_chain"], time_budget_s=5, no_llm=True
    )
    assert rep.status in ("ok", "partial")

    gate_obj = cast(
        object,
        json.loads(
            (info.run_dir / "stages" / "exploit_gate" / "stage.json").read_text(
                encoding="utf-8"
            )
        ),
    )
    assert cast(dict[str, object], gate_obj).get("status") == "ok"

    milestones = info.run_dir / "stages" / "exploit_chain" / "milestones.json"
    assert milestones.is_file()
    obj = cast(dict[str, object], json.loads(milestones.read_text(encoding="utf-8")))
    assert cast(dict[str, object], obj.get("canonical_input")).get("path") == (
        "input/firmware.bin"
    )
    assert cast(dict[str, object], obj.get("canonical_input")).get("sha256") == cast(
        dict[str, object],
        json.loads(info.manifest_path.read_text(encoding="utf-8")),
    ).get("input_sha256")
    ids = [
        cast(dict[str, object], m).get("id")
        for m in cast(list[object], obj.get("milestones"))
    ]
    assert ids == ["reachability", "bounded_impact", "postcondition"]
