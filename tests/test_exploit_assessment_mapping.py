from __future__ import annotations

from aiedge.reporting import build_exploit_assessment_from_digest_verdict
from aiedge.schema import JsonValue


def _stage_statuses() -> dict[str, JsonValue]:
    return {
        "exploit_gate": "ok",
        "exploit_chain": "ok",
        "poc_validation": "ok",
        "exploit_policy": "ok",
    }


def test_exploit_assessment_non_exploit_profile_is_not_requested() -> None:
    assessment = build_exploit_assessment_from_digest_verdict(
        profile="analysis",
        stage_statuses=_stage_statuses(),
        digest_verdict=None,
    )

    assert assessment["decision"] == "not_requested"
    assert assessment["exploitable"] is None
    assert assessment["reason_codes"] == ["PROFILE_NOT_EXPLOIT"]


def test_exploit_assessment_uses_digest_verdict_state_and_reasons() -> None:
    assessment = build_exploit_assessment_from_digest_verdict(
        profile="exploit",
        stage_statuses=_stage_statuses(),
        digest_verdict={
            "state": "ATTEMPTED_INCONCLUSIVE",
            "reason_codes": ["ATTEMPTED_VERIFIER_FAILED"],
        },
    )

    assert assessment["decision"] == "ATTEMPTED_INCONCLUSIVE"
    assert assessment["reason_codes"] == ["ATTEMPTED_VERIFIER_FAILED"]
    assert assessment["exploitable"] is None


def test_exploit_assessment_not_applicable_sets_exploitable_false() -> None:
    assessment = build_exploit_assessment_from_digest_verdict(
        profile="exploit",
        stage_statuses=_stage_statuses(),
        digest_verdict={
            "state": "NOT_APPLICABLE",
            "reason_codes": ["NOT_APPLICABLE_NO_RELEVANT_FINDINGS"],
        },
    )

    assert assessment["decision"] == "NOT_APPLICABLE"
    assert assessment["reason_codes"] == ["NOT_APPLICABLE_NO_RELEVANT_FINDINGS"]
    assert assessment["exploitable"] is False
