from __future__ import annotations

import json
from pathlib import Path
from typing import cast

import pytest

import aiedge.run as run_mod
from aiedge.__main__ import main


def _write_firmware(tmp_path: Path) -> Path:
    fw = tmp_path / "fw.bin"
    _ = fw.write_bytes(b"firmware")
    return fw


def test_cli_profile_exploit_requires_gate_flags(
    tmp_path: Path,
    capsys: pytest.CaptureFixture[str],
    monkeypatch: pytest.MonkeyPatch,
) -> None:
    monkeypatch.chdir(tmp_path)
    fw = _write_firmware(tmp_path)

    rc = main(
        [
            "analyze",
            str(fw),
            "--case-id",
            "case-exploit-missing",
            "--ack-authorization",
            "--profile",
            "exploit",
            "--no-llm",
        ]
    )
    captured = capsys.readouterr()
    assert rc == 30
    assert "Exploit profile requires" in captured.err


def test_cli_profile_exploit_records_gate_in_manifest(
    tmp_path: Path,
    capsys: pytest.CaptureFixture[str],
    monkeypatch: pytest.MonkeyPatch,
) -> None:
    monkeypatch.chdir(tmp_path)
    fw = _write_firmware(tmp_path)

    def fake_analyze_run(
        _info: run_mod.RunInfo,
        *,
        time_budget_s: int,
        no_llm: bool,
        force_retriage: bool,
    ) -> str:
        _ = time_budget_s, no_llm, force_retriage
        return "ok"

    monkeypatch.setattr(run_mod, "analyze_run", fake_analyze_run)

    rc = main(
        [
            "analyze",
            str(fw),
            "--case-id",
            "case-exploit-ok",
            "--ack-authorization",
            "--profile",
            "exploit",
            "--exploit-flag",
            "flag",
            "--exploit-attestation",
            "authorized",
            "--exploit-scope",
            "lab-only",
            "--no-llm",
            "--time-budget-s",
            "1",
        ]
    )
    assert rc == 0

    run_dir = Path(capsys.readouterr().out.strip())
    manifest = cast(
        dict[str, object],
        json.loads((run_dir / "manifest.json").read_text(encoding="utf-8")),
    )
    assert manifest.get("profile") == "exploit"
    gate = manifest.get("exploit_gate")
    assert isinstance(gate, dict)
    assert cast(dict[str, object], gate).get("scope") == "lab-only"
