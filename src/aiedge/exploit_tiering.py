from __future__ import annotations

from typing import cast

EXPLOITABILITY_TIERS: tuple[str, ...] = (
    "suspected",
    "strong_static",
    "dynamic_repro",
    "exploitability_assessed",
)

TIER_INVALID_VALUE = "TIER_INVALID_VALUE"
TIER_EVIDENCE_MISSING = "TIER_EVIDENCE_MISSING"
TIER_HIGH_SEVERITY_REQUIRES_T2 = "TIER_HIGH_SEVERITY_REQUIRES_T2"

_TIER_RANK: dict[str, int] = {
    tier: idx for idx, tier in enumerate(EXPLOITABILITY_TIERS)
}

EXPLOIT_EVIDENCE_PREFIXES: tuple[str, ...] = (
    "stages/exploit_gate/",
    "stages/exploit_chain/",
    "stages/poc_validation/",
    "stages/exploit_policy/",
)


def is_valid_exploitability_tier(value: object) -> bool:
    return isinstance(value, str) and value in _TIER_RANK


def exploitability_tier_rank(value: object) -> int | None:
    if not isinstance(value, str):
        return None
    return _TIER_RANK.get(value)


def default_exploitability_tier(*, disposition: object) -> str:
    if disposition == "confirmed":
        return "strong_static"
    return "suspected"


def has_exploit_artifact_reference(refs: object) -> bool:
    if not isinstance(refs, list):
        return False
    for ref_any in cast(list[object], refs):
        ref = ""
        if isinstance(ref_any, str):
            ref = ref_any
        elif isinstance(ref_any, dict):
            path_any = cast(dict[str, object], ref_any).get("path")
            if isinstance(path_any, str):
                ref = path_any
        if not ref:
            continue
        ref = ref.replace("\\", "/")
        if any(ref.startswith(prefix) for prefix in EXPLOIT_EVIDENCE_PREFIXES):
            return True
    return False
