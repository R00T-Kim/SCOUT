#!/usr/bin/env bash
set -euo pipefail

if [ "$#" -lt 1 ]; then
  echo "usage: priv-run <command> [args...]" >&2
  exit 64
fi

if [ "$(id -u)" -eq 0 ]; then
  exec "$@"
fi

if command -v sudo >/dev/null 2>&1; then
  if [ -n "${SUDO_PASSWORD:-}" ]; then
    printf '%s\n' "$SUDO_PASSWORD" | sudo -S -p '' -- "$@"
    exit $?
  fi
  exec sudo -n -- "$@"
fi

echo "priv-run: sudo unavailable and current user is not root" >&2
exit 77
